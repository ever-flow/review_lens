# app.py
import os
import sys
import subprocess

import streamlit as st
import pandas as pd

from crawler import (
    crawl_kakao_reviews,
    crawl_google_reviews,
    crawl_naver_reviews,
)
from analysis import (
    analyze_reviews,
    generate_prompt,
    generate_consumer_prompt,
)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# í˜ì´ì§€ ì„¤ì •
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.set_page_config(page_title="ë¦¬ë·° ë¶„ì„ ì•±", layout="wide")
st.title("ğŸ½ï¸ ì‹ë‹¹ ë¦¬ë·° í¬ë¡¤ë§ & ë¶„ì„")


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1) ì„¸ì…˜ ìŠ¤í…Œì´íŠ¸ ì´ˆê¸°í™”
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if 'submitted' not in st.session_state:
    st.session_state.submitted = False

if 'last_name' not in st.session_state:
    st.session_state.last_name = ""


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2) ì‚¬ì´ë“œë°” í¼
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with st.sidebar:
    with st.form('control_form'):
        restaurant_name = st.text_input(
            "ì‹ë‹¹ ì´ë¦„ì„ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.(ì§€ì  ë° ë„ì–´ì“°ê¸° í¬í•¨)",
            help="ì˜ˆ: 'ë²„ê±°í‚¹ ì—°ì„¸ë¡œì ', 'ì¥ì •ì • ì„ ë¦‰ ë³¸ì ' ë“±ìœ¼ë¡œ ì •í™•íˆ ì…ë ¥"
        )
        user_type = st.radio("ëª¨ë“œ ì„ íƒ", ("ì‹ë‹¹ì£¼ì¸ìš©", "ê³ ê°ìš©"))
        submitted_click = st.form_submit_button("ğŸ” ë¶„ì„ ì‹œì‘")

# 3) â€œë¶„ì„ ì‹œì‘â€ ë²„íŠ¼ì´ ëˆŒë¦¬ë©´ submitted=Trueë¡œ, 
#    ê·¸ë¦¬ê³  ì‹ë‹¹ ì´ë¦„ì´ ë°”ë€Œë©´ ì´ì „ promptë¥¼ ì‚­ì œ
if submitted_click:
    st.session_state.submitted = True
    if restaurant_name != st.session_state.last_name:
        if 'prompt' in st.session_state:
            del st.session_state['prompt']
        st.session_state.last_name = restaurant_name

# 4) ë¶„ì„ ì „ ëŒ€ê¸°
if not st.session_state.submitted:
    st.info("ì‚¬ì´ë“œë°”ì—ì„œ ì‹ë‹¹ ì´ë¦„ì„ ì…ë ¥í•˜ê³  â€˜ë¶„ì„ ì‹œì‘â€™ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”.")
    st.stop()

# 5) ì…ë ¥ ê²€ì¦
if not restaurant_name:
    st.warning("ì‹ë‹¹ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.")
    st.stop()


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 6) í¬ë¡¤ë§ (í•œ ë²ˆë§Œ ì‹¤í–‰, ìºì‹œ)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@st.cache_data(show_spinner=False)
def get_all_reviews(name: str):
    kakao = crawl_kakao_reviews(name)
    google = crawl_google_reviews(name)
    naver = crawl_naver_reviews(name)
    return kakao + google + naver

with st.spinner("1/3 í¬ë¡¤ë§ ì¤‘â€¦"):
    all_reviews = get_all_reviews(restaurant_name)

if not all_reviews:
    st.error("ë¦¬ë·°ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
    st.stop()


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 7) ì›ë³¸ ë¦¬ë·° í…Œì´ë¸”
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
df = pd.DataFrame(all_reviews)
st.subheader("âœ… ìˆ˜ì§‘ëœ ì›ë³¸ ë¦¬ë·°")
# ì‹ë‹¹ ì´ë¦„ ì»¬ëŸ¼ë„ ê°™ì´ ë³´ì—¬ì£¼ë„ë¡ ë³€ê²½
st.dataframe(df[["platform","restaurant_name","reviewer","text","rating","date"]], height=300)


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 8) í”Œë«í¼ë³„ ì‹¤ì œ ì‹ë‹¹ ì´ë¦„ ë³´ì—¬ì£¼ê¸°
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.subheader("ğŸ“ í”Œë«í¼ë³„ ë¦¬ë·°ë¥¼ ê°€ì ¸ì˜¨ ì‹ë‹¹ ì´ë¦„")
platform_names = df[["platform", "restaurant_name"]].drop_duplicates().reset_index(drop=True)
st.table(platform_names)


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 9) ê°ì„±Â·í‚¤ì›Œë“œ ë¶„ì„
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with st.spinner("2/3 ê°ì„± ë¶„ì„ ë° í‚¤ì›Œë“œ ì¶”ì¶œâ€¦"):
    df_proc, keywords, pos_ratio, neg_ratio, top_pos, top_neg, aspects, total = analyze_reviews(df)


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 10) í”„ë¡¬í”„íŠ¸ ìƒì„±
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if 'prompt' not in st.session_state:
    if user_type == "ì‹ë‹¹ì£¼ì¸ìš©":
        df_kw = pd.DataFrame({
            aspect: [", ".join(f"{w}({s:.2f})" for w, s in kws)]
            for aspect, kws in keywords.items()
        }, index=["í‚¤ì›Œë“œ"]).T
        st.subheader("ğŸ”‘ í•µì‹¬ í‚¤ì›Œë“œ (í…Œì´ë¸”)")
        st.table(df_kw)
        st.write(f"ê¸ì • ë¹„ìœ¨: {pos_ratio:.1f}%  |  ë¶€ì • ë¹„ìœ¨: {neg_ratio:.1f}%")

        with st.spinner("3/3 ì£¼ì¸ìš© LLM í”„ë¡¬í”„íŠ¸ ìƒì„±â€¦"):
            prompt = generate_prompt(
                name=restaurant_name,
                keywords=keywords,
                pos_ratio=pos_ratio,
                neg_ratio=neg_ratio,
                aspects=aspects,
                top_pos=top_pos,
                top_neg=top_neg,
                classified_count=total
            )
    else:
        with st.spinner("3/3 ê³ ê°ìš© LLM í”„ë¡¬í”„íŠ¸ ìƒì„±â€¦"):
            prompt = generate_consumer_prompt(
                name=restaurant_name,
                keywords=keywords,
                pos_ratio=pos_ratio,
                neg_ratio=neg_ratio,
                aspects=aspects,
                top_pos=top_pos,
                top_neg=top_neg,
                classified_count=total
            )
    st.session_state['prompt'] = prompt

prompt = st.session_state['prompt']


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 11) í”„ë¡¬í”„íŠ¸ ì¶œë ¥
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.subheader("ğŸ“ LLM ìš”ì²­ í”„ë¡¬í”„íŠ¸")
st.code(prompt, language="plain")


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 12) Gemini ì „ì†¡ ë²„íŠ¼
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if st.button("ğŸ”— Geminiì— ì „ì†¡"):
    script_dir  = os.path.dirname(os.path.abspath(__file__))
    send_script = os.path.join(script_dir, "send_prompt.py")
    subprocess.Popen([sys.executable, send_script, prompt])
    st.success("Gemini ì „ì†¡ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í–ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì°½ì„ í™•ì¸í•´ì£¼ì„¸ìš”.")
